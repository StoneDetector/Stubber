
# Stubber : Compiling Source Code into Bytecode without Dependencies
for Java Code Clone Detection

Stubber is a tool to create compilable Java files from Java source code files without dependencies. The Stubber tool can make 95% of all Java files compilable in BigCloneBench. Thereby 92.5% of all clones are preserved. Of course, the Stubber tool can also be applied to other Java files.

# Prepared files for the BigCloneBench and the BigCloneEval
* First of all [BigCloneEval](https://github.com/jeffsvajlenko/BigCloneEval) must be installed
* The database must then be replaced with [this](https://drive.google.com/file/d/1c95ubC-UBCAU0rudj6_UWSaE926qPxq_/view?usp=sharing) database, in which all non-compilable files and clones have been removed
* The Java files in bcb_reduced must then be replaced with [these](https://drive.google.com/file/d/1-tjdLO3LUny1Kv6Nd1wHpiaXrK45_IPA/view?usp=sharing) files

# Identify Clones for BCB 
Methods in clone pairs are identified by BigCloneEval using the subfolder and the Java source file they are located in, as well as their respective start and end line in the source file. Apparently, the line numbers of the files generated by the Stubber tool can not be used for that purpose. Instead, the tool offers a way for mapping the generated Java Bytecode methods back to the original Java source code methods files.
The Stubber tool creates annotatations for the methods during compilation to Java Bytecode, containing the methods’ location information as required by BigCloneEval. Furthermore, the annotations can be used to distinguish between methods included in the original Java source files and methods which have been artifically introduced by the Stubber tool to enable Bytecode compilation. The definition of the used annotation interface is part of the StubClass subpackage included in the generated JAR files. The annotation is visible in Java Bytecode and can be programmatically accessed. For convenient usage, the Stubber tool includes a script (utils/ByteCodeInfos) which maps the methods in the Java Bytecode to the respective original methods in the Java source code. To this end, the script parses the annotations in the generated Bytecode class files and generates a CSV file [ByteCodeInfo.csv](https://drive.google.com/file/d/17WpHUHYJrY0c8HD3-53GJXe-hgpg_GZa/view?usp=sharing), in which for each method of the class file, the source code location information is stored. Additionally, the CSV file also contains information about the method name and the method’s reference in the Bytecode’s constant pool. The script can also be used as blueprint for accessing the annotations programmatically, e.g., when implementing a clone detector using Soot or Wala.

The CSV file is structured as follows:
```
Path/To/Jar, Subfolder, Java_file_name, Start_line, End_line, Class_name_in_the_jar , Function_name , Address_of_the_name_in_the_constants_pool, Address_of_the_signature_in_the_constants_pool
```
Example:
```
2/default/137166.jar, default, 137166.java, 26, 28, _137166.Configuration.class, replace_localFunction1, 64, 65
```

When a clone pair is returned, the information in the ByteCodeInfo.csv can now simply be used. 
Example:
```
default,137166.java,26,28,default,137166.java,50,52
```
Such an output can then be processed by BigCloneEval.

# Run the Stubber tool yourself (not needed for BCB/BCE)
To run the Stubber tool use the following command:
```
./gradlew -Dorg.gradle.java.home=/usr/lib/jvm/java-1.11.0-openjdk-amd64 run -PmainClass=Stubber --args="-s -r -t=5 -k"
```
Note that java 11 is needed. 
The input files should be in a folder named BigCloneBenchFiles. The output is generated in a folder named Stubfiles.
There are 5 arguments:
* -r : Creates random bodies for methods added by Stubber. The random bodies for functions with the same name will be equal.
* -t : Sets the maximum number of threads to be used. Default is 5.
* -d : Debug mode with more output and only one thread.
* -k : Keeps the uncompilable files.
* -s : Copies the compilable stubbed source files outside of the jar. This should be used, if bytecode based clone detection tools and source code based detection tools are to be compared. The Stubber tool also creates a file called "StubbedSourceCodeLines". The file contains a line mapping of the original files and the java files created by the Stubber. 
	* The csv file is structured as follows:
``` 
Foldername, Subfolder, Java_file_name, Startline_of_stubbed_java_file, Endline_of_stubbed_java_file, Startline_of_original_java_file, Endline_of_original_java_file
```
If you use the stubbed source code files for clone detection with a source code based clone detector like NiCad, use the transformBCEoutputForStubbedSourceFiles.py script in the utils/sourceCodeTransformation folder.
* Transform the NiCad output to the format needed by BigCloneEval.
* Run the following, where transformed_output is the file with the transformed information ready to be evaluated with BigCloneEval.
```
python transformBCEoutputForStubbedSourceFiles.py ../../StubbedSourceCodeLines output_file_from_NiCad transformed_output
```
Note that for the evaluation with BigCloneEval the uncompilable files and the associated clones have to be removed from the BigCloneEval Database.

# Remove uncompilable Files and associated Clones from the BigCloneEval Database yourself

Go into the utils/db folder.
```
cd utils/db
```
Execute the follwing command with your path to your BigCloneEval bcb-database file and your path to your h2-jar:
```
java -cp /path/to/your/h2-1.4.200.jar org.h2.tools.RunScript -url "jdbc:h2:file://path/to/your/original/bcb" -user sa -script query.sql -showResults
```
The query.sql script creates a dumb of the database in the file "db-dump.sql". 
Move the file into the input folder:
```
mv db-dump.sql input/.
```
Move the file with all uncompilable files in the input folder:
```
mv ../../errorFiles input/. 
```
Execute the deleteAllUncompilables.py script (A new dump will be created without all uncompilable files and associated functions called newSQL.sqlp):
```
python deleteAllUncompilables.py
```
Create a new bcb-database file:
```
java -cp /path/to/your/h2-1.4.200.jar org.h2.tools.RunScript -url "jdbc:h2:file:/path/to/new/bcb/file/location/bcb;MV_STORE=false" -user sa -script newSQL.sqlp -showResults
```
You can replace the original bcb file in the BigCloneEval/bigclonebenchdb with the newly created one. Now just copy the created Jars from Stubber/StubFiles to BigCloneEval/ijadataset/bcb_reduced and you are ready to evaluated the results of your bytecode based clone detection tool with BigCloneEval.

# Create ByteCodeInfo yourself
Go into the directory utils/ByteCoeInfos. 
```
cd utils/ByteCodeInfos
```
Note that java 8 is needed and run:
```
./gradlew -Dorg.gradle.java.home=/usr/lib/jvm/java-1.8.0-openjdk-amd64/ run -PmainClass=ByteCodeInfos --args="-d=../../StubFiles -t=5 -o=output"
```
There are 3 arguments:
* -d : Sets the input directory where the jar files are located.
* -t : Sets the maximum number of threads to be used. Default is 1.
* -o : Sets the path  to the output file.
